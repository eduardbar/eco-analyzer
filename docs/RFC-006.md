# RFC-006: Estrategia de Dockerización y Despliegue

**Fecha:** 2025-08-06 **Autor:** Equipo de DevOps **Estado:** Propuesto

## 1. Resumen

Este RFC describe la estrategia para contenerizar todos los componentes de la aplicación (Frontend, Backend, Base de Datos) utilizando **Docker** y **Docker Compose**. El objetivo es crear un entorno de desarrollo consistente, simplificar la configuración y preparar la aplicación para un despliegue escalable en producción.

## 2. Archivos Docker

Se crearán tres archivos principales en la raíz del monorepo.

### `Dockerfile.frontend`

Este archivo construirá la imagen de producción para la aplicación Next.js.

```
# Stage 1: Build
FROM node:18-alpine AS builder
WORKDIR /app
COPY frontend/package*.json ./
RUN npm install
COPY frontend/ .
RUN npm run build

# Stage 2: Production
FROM node:18-alpine
WORKDIR /app
COPY --from=builder /app/next.config.mjs ./
COPY --from=builder /app/public ./public
COPY --from=builder /app/package.json ./
COPY --from=builder /app/.next/standalone ./
COPY --from=builder /app/.next/static ./.next/static

ENV PORT 3000
EXPOSE 3000

CMD ["node", "server.js"]
```

- **Multi-stage Build:** Se utiliza para mantener la imagen final lo más pequeña posible, incluyendo solo los artefactos necesarios para ejecutar la aplicación.

### `Dockerfile.backend`

Este archivo construirá la imagen para el servidor Node.js/Express.

```
FROM node:18-alpine
WORKDIR /app
COPY backend/package*.json ./
RUN npm install
COPY backend/ .
# Copiar el cliente de Prisma generado
COPY --from=builder /app/node_modules/.prisma ./node_modules/.prisma
RUN npx prisma generate
RUN npm run build
EXPOSE 8000
CMD ["node", "dist/server.js"]
```

### `docker-compose.yml`

Este archivo orquesta todos los servicios.

```
version: '3.8'

services:
  # Servicio de Base de Datos MySQL
  db:
    image: mysql:8.0
    container_name: analyzer-db
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
      MYSQL_DATABASE: ${DB_NAME}
      MYSQL_USER: ${DB_USER}
      MYSQL_PASSWORD: ${DB_PASSWORD}
    ports:
      - "3306:3306"
    volumes:
      - db-data:/var/lib/mysql

  # Servicio del Backend
  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
    container_name: analyzer-backend
    restart: unless-stopped
    depends_on:
      - db
    ports:
      - "8000:8000"
    environment:
      DATABASE_URL: "mysql://${DB_USER}:${DB_PASSWORD}@db:3306/${DB_NAME}"
      JWT_SECRET: ${JWT_SECRET}
      OPENAI_API_KEY: ${OPENAI_API_KEY}

  # Servicio del Frontend
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
    container_name: analyzer-frontend
    restart: unless-stopped
    depends_on:
      - backend
    ports:
      - "3000:3000"
    environment:
      NEXT_PUBLIC_API_URL: "http://localhost:8000/api/v1"

volumes:
  db-data:
```

- **Variables de Entorno:** Todas las configuraciones sensibles (contraseñas, claves de API) se gestionan a través de un archivo `.env` en la raíz, que es leído por Docker Compose.

## 3. Flujo de Trabajo de Desarrollo

1. Crear un archivo `.env` en la raíz del proyecto con todas las variables definidas en `docker-compose.yml`.
2. Ejecutar `docker-compose up --build` desde la raíz del proyecto.
3. Docker Compose construirá las imágenes (si no existen) y levantará los tres contenedores, conectándolos en una red interna.
4. El desarrollador podrá acceder al frontend en `http://localhost:3000`, que se comunicará con el backend en `http://localhost:8000`, y este a su vez con la base de datos en el puerto `3306`.

## 4. Estrategia de Despliegue en Producción

Para producción, se puede utilizar una plataforma como **AWS (con ECS), Google Cloud (con Cloud Run), o Fly.io**. El proceso sería:

1. Construir y subir las imágenes de Docker a un registro de contenedores (Docker Hub, ECR, GCR).
2. Utilizar una base de datos gestionada (como AWS RDS) en lugar de un contenedor de MySQL.
3. Configurar los servicios en la plataforma elegida para que utilicen las imágenes del registro y las variables de entorno de producción.