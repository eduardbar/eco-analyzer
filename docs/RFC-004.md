# RFC-004: Esquema de Base de Datos y Configuración de Prisma

**Fecha:** 2025-08-06 **Autor:** Equipo de Backend **Estado:** Aprobado

## 1. Resumen

Este RFC proporciona la definición final y detallada del esquema de la base de datos y el flujo de trabajo para gestionarlo utilizando **Prisma** como ORM y **MySQL** como la base de datos.

## 2. Archivo de Esquema (`prisma/schema.prisma`)

Este único archivo será la fuente de verdad para la estructura de nuestra base de datos.

```
// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String
  name      String?

  analyses  Analysis[] // Un usuario puede tener muchos análisis

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Analysis {
  id              Int      @id @default(autoincrement())
  productTitle    String
  ecoScore        Float
  summary         String   @db.Text
  carbonFootprint Float
  waterUsage      Float

  materials       MaterialAnalysis[] // Un análisis tiene un desglose de materiales

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId          Int

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model MaterialAnalysis {
  id                   Int     @id @default(autoincrement())
  materialName         String
  sustainabilityScore  Float
  notes                String  @db.Text

  analysis             Analysis @relation(fields: [analysisId], references: [id], onDelete: Cascade)
  analysisId           Int
}
```

### Decisiones Clave del Esquema:

- **`onDelete: Cascade`:** En las relaciones, se ha añadido `onDelete: Cascade`. Esto significa que si un `User` es eliminado, todos sus `Analysis` asociados también serán eliminados. De igual forma, si un `Analysis` es eliminado, todos sus `MaterialAnalysis` se eliminarán. Esto mantiene la integridad de los datos automáticamente.
- **Tipos de Datos:** Se ha usado `@db.Text` para los campos `summary` y `notes` para permitir textos de longitud variable, más largos que un `String` estándar (VARCHAR).

## 3. Flujo de Trabajo de Migración

La gestión de los cambios en el esquema de la base de datos será un proceso estrictamente controlado a través de la CLI de Prisma.

1. **Modificar el Esquema:** Cualquier cambio en la estructura de la base de datos se realiza **primero** en el archivo `prisma/schema.prisma`.

2. **Crear una Migración:** Se ejecuta el siguiente comando en la terminal:

   ```
   npx prisma migrate dev --name <nombre-descriptivo-de-la-migracion>
   ```

   - **¿Qué hace este comando?**
     1. Prisma compara el `schema.prisma` con el estado actual de la base de datos.
     2. Genera un nuevo archivo de migración SQL en la carpeta `prisma/migrations/`. Este archivo contiene las sentencias SQL exactas (`CREATE TABLE`, `ALTER TABLE`, etc.) para actualizar la base de datos.
     3. Aplica esta migración a la base de datos de desarrollo.
     4. Regenera el Prisma Client (`@prisma/client`) para que esté sincronizado con el nuevo esquema y ofrezca autocompletado y seguridad de tipos actualizados.

3. **Aplicar en Producción:** En un entorno de producción, se ejecutará `npx prisma migrate deploy`. Este comando no genera nuevos archivos, simplemente aplica todas las migraciones pendientes que aún no se han ejecutado en esa base de datos.

## 4. Cliente de Prisma

El acceso a la base de datos desde el código de la aplicación se realizará exclusivamente a través del Prisma Client. Se creará una única instancia del cliente y se exportará para ser utilizada en toda la aplicación (patrón Singleton) para evitar la creación de múltiples conexiones a la base de datos.

**`src/lib/prisma.ts`**

```
import { PrismaClient } from '@prisma/client';

declare global {
  var prisma: PrismaClient | undefined;
}

export const prisma = global.prisma || new PrismaClient();

if (process.env.NODE_ENV !== 'production') global.prisma = prisma;
```