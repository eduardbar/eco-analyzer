# RFC-003: Diseño de API del Backend y Autenticación

**Fecha:** 2025-08-06 **Autor:** Equipo de Backend **Estado:** Aprobado

## 1. Resumen

Este RFC detalla el diseño de la API REST para el servidor backend construido con **Node.js** y **Express.js**. Define los endpoints, las estructuras de solicitud/respuesta y el mecanismo de autenticación basado en **JSON Web Tokens (JWT)**.

## 2. Principios de Diseño de la API

- **RESTful:** Seguir las convenciones de REST para las rutas y los métodos HTTP.
- **Versionada:** Todas las rutas estarán prefijadas con `/api/v1` para facilitar futuras actualizaciones sin romper la compatibilidad con clientes antiguos.
- **Stateless:** El servidor no mantendrá estado de la sesión. Cada solicitud del cliente debe contener toda la información necesaria para ser procesada, incluida la autenticación (token JWT).
- **JSON:** Todas las solicitudes y respuestas usarán el formato JSON.

## 3. Endpoints de la API

### Autenticación (`/api/v1/auth`)

- **`POST /register`**
  - **Descripción:** Registra un nuevo usuario.
  - **Cuerpo de la Solicitud:** `{ "email": "user@example.com", "password": "password123", "name": "John Doe" }`
  - **Respuesta Exitosa (201):** `{ "message": "User registered successfully" }`
  - **Respuesta de Error (400/409):** Si los datos son inválidos o el email ya existe.
- **`POST /login`**
  - **Descripción:** Autentica a un usuario y devuelve un token JWT.
  - **Cuerpo de la Solicitud:** `{ "email": "user@example.com", "password": "password123" }`
  - **Respuesta Exitosa (200):** `{ "token": "ey...", "user": { "id": 1, "email": "...", "name": "..." } }`
  - **Respuesta de Error (401):** Si las credenciales son incorrectas.

### Análisis (`/api/v1/analysis`) - *Ruta Protegida*

- **`POST /`**
  - **Descripción:** Inicia un nuevo análisis de producto. Requiere autenticación.
  - **Header de Autenticación:** `Authorization: Bearer <token>`
  - **Cuerpo de la Solicitud:** `{ "description": "Camiseta 100% algodón orgánico" }`
  - **Respuesta Exitosa (201):** Devuelve el objeto de análisis completo guardado en la base de datos (ver RFC-004 para la estructura).
  - **Respuesta de Error (400/500):** Si la descripción falta o si hay un error interno.
- **`GET /`**
  - **Descripción:** Obtiene el historial de análisis del usuario autenticado.
  - **Header de Autenticación:** `Authorization: Bearer <token>`
  - **Respuesta Exitosa (200):** `[ { analysis1 }, { analysis2 }, ... ]` (un array de objetos de análisis).

## 4. Mecanismo de Autenticación (JWT)

1. **Login:** Cuando un usuario inicia sesión correctamente, el servidor genera un token JWT.
   - **Payload del Token:** Contendrá información no sensible como el `userId`.
   - **Firma:** El token se firmará con un secreto (`JWT_SECRET`) almacenado en las variables de entorno del servidor.
2. **Almacenamiento del Token:** El frontend almacenará el token de forma segura (por ejemplo, en `localStorage` o una cookie `httpOnly`).
3. **Solicitudes Protegidas:** Para cada solicitud a una ruta protegida, el frontend incluirá el token en el header `Authorization` con el esquema `Bearer`.
4. **Middleware de Verificación:** Se creará un middleware de Express (`auth.middleware.ts`) que se ejecutará antes de cada controlador de ruta protegida.
   - Extraerá el token del header.
   - Verificará la firma del token usando el `JWT_SECRET`.
   - Si el token es válido, decodificará el payload, extraerá el `userId` y lo añadirá al objeto `request` (ej. `req.user = { id: userId }`) para que esté disponible en los siguientes controladores.
   - Si el token es inválido o no existe, devolverá un error 401.